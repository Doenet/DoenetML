name: Node.js CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["*"]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci

            - name: Build
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build:all-no-docs
              # set the environmental variable WIREIT_CACHE="local" so that the wireit cache is saved in the .wireit directory.
              env:
                  WIREIT_CACHE: "local"

            - name: Debug Build Artifacts
              run: |
                  ls -la ./packages/*/.wireit/ || echo "No .wireit directory found"
                  du -sh ./packages/*/.wireit/*/

            # upload all the .wireit directories so that the test job can use them.
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  include-hidden-files: true
                  # Include package.json from the root so the file tree matches the full file tree of the repo
                  # (otherwise everything is normalized to the closest common ancestor folder)
                  path: |
                      ./packages/*/.wireit/**/*
                      ./package.json

    test-main:
        name: Test Main
        runs-on: ubuntu-latest
        needs: build
        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Debug Build Artifacts
              run: |
                  ls -la ./packages/*/.wireit/ || echo "No .wireit directory found"

            # with the wireit cache saved, this build step should be fast.
            - name: Build (cached)
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build:all-no-docs
              env:
                  WIREIT_CACHE: "local"

            - name: Test
              run: npm run test:all-no-worker-js

    test-worker-js:
        name: Test Worker JS
        runs-on: ubuntu-latest
        needs: build
        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Debug Build Artifacts
              run: |
                  ls -la ./packages/*/.wireit/ || echo "No .wireit directory found"

            # with the wireit cache saved, this build step should be fast.
            - name: Build (cached)
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build -w packages/doenetml-worker
              env:
                  WIREIT_CACHE: "local"

            - name: Test doenetml-worker-javascript
              run: npm run test -w packages/doenetml-worker-javascript

    test-cypress:
        name: Cypress Tests
        runs-on: ubuntu-latest
        needs: build
        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Debug Build Artifacts
              run: |
                  ls -la ./packages/*/.wireit/ || echo "No .wireit directory found"

            # with the wireit cache saved, this build step should be fast.
            - name: Build (cached)
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build --workspace packages/test-cypress
              env:
                  WIREIT_CACHE: "local"

            - name: Cypress run
              uses: cypress-io/github-action@v6
              with:
                  browser: chrome
                  start: npm run preview --workspace packages/test-cypress
                  project: ./packages/test-cypress
                  wait-on: "http://localhost:4173"
              env:
                  CYPRESS_SKIP_YOUTUBE_TESTS: true

            - name: Upload screenshots on failure
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: cypress-screenshots
                  path: ./packages/test-cypress/cypress/screenshots

    lint:
        name: Lint Rust Code
        runs-on: ubuntu-latest

        steps:
            - name: Checkout sources
              uses: actions/checkout@v3

            - name: Install toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true
                  components: rustfmt, clippy

            - name: Cargo fmt
              working-directory: ./packages/doenetml-worker-rust
              run: cargo fmt --all -- --check

            - name: Cargo clippy
              working-directory: ./packages/doenetml-worker-rust
              run: cargo clippy -- -D warnings

    build-docs:
        runs-on: ubuntu-latest
        needs: build
        name: Build Docs

        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts
                  path: ./

            # with the wireit cache saved, this build step should be fast.
            - name: Build Docs
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build:docs
              env:
                  WIREIT_CACHE: "local"

    lint-ts:
        name: Lint Typescript Code
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [24.x]

        steps:
            - name: Checkout sources
              uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
            - run: npm ci

            - name: Prettier Check
              run: npx prettier . --check --ignore-path ./.prettierignore --ignore-path ./.prettierignoreci

    dev-release:
        name: Dev Release
        runs-on: ubuntu-latest
        needs: [test-main, test-worker-js, test-cypress]
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        permissions:
            id-token: write
            contents: read
        strategy:
            matrix:
                node-version: [24.x]

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  registry-url: https://registry.npmjs.org
                  cache: "npm"
            - run: npm ci

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Debug Build Artifacts
              run: |
                  ls -la ./packages/*/.wireit/ || echo "No .wireit directory found"

            - name: Update versions
              run: |
                  CURRENT_VERSION=$(node -p "require('./packages/doenetml/package.json').version")
                  TIMESTAMP=$(date +%Y%m%d%H%M%S)
                  COMMIT_HASH=$(git rev-parse --short HEAD)
                  VERSION="${CURRENT_VERSION}-dev.${TIMESTAMP}.${COMMIT_HASH}"
                  npm run version -- ${VERSION} --no-git-tag-version

            - name: Build workspaces
              run: |
                  export NODE_OPTIONS="--max_old_space_size=6114"
                  npm run build -w packages/doenetml -w packages/standalone -w packages/doenetml-iframe -w packages/v06-to-v07
              env:
                  WIREIT_CACHE: "local"

            - name: Publish dev release
              run: npm run publish -- --tag dev
              env:
                  WIREIT_CACHE: "local"

            - name: Purge jsDelivr cache
              run: |
                  echo "Waiting for npm package propagation before purging jsDelivr cache..."
                  sleep 15

                  echo "Purging jsDelivr cache for @doenet/standalone@dev (package-level)..."
                  if ! curl -fv https://purge.jsdelivr.net/npm/@doenet/standalone@dev; then
                      echo "Error: Failed to purge package-level cache for @doenet/standalone@dev" >&2
                      exit 1
                  fi

                  echo "Purging jsDelivr cache for @doenet/standalone@dev/doenet-standalone.js..."
                  if ! curl -fv https://purge.jsdelivr.net/npm/@doenet/standalone@dev/doenet-standalone.js; then
                      echo "Error: Failed to purge cache for doenet-standalone.js" >&2
                      exit 1
                  fi

                  echo "Purging jsDelivr cache for @doenet/standalone@dev/style.css..."
                  if ! curl -fv https://purge.jsdelivr.net/npm/@doenet/standalone@dev/style.css; then
                      echo "Error: Failed to purge cache for style.css" >&2
                      exit 1
                  fi
